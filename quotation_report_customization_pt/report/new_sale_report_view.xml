<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- BASE override #For Header (Logo/Address)-->
    <template id="web.external_layout_boxed">
        <div t-attf-class="header o_company_#{company.id}_layout" t-att-style="report_header_style">
            <div class="o_boxed_header">
            <div class="row mb8">
                <div class="col-6" style="margin-top: 40px;">
                    <img t-if="company.logo" t-att-src="image_data_uri(company.logo)" alt="Logo" style="height: 50px; width: 250px;"/>
                </div>
                <div class="col-6 text-right">
                    <h4 class="mt0" t-field="company.report_header"/>
                    <div name="company_address" class="float-right mb4">
                        <t t-if="company.name"> <span t-field="company.name"/><br/></t>
                        <t t-if="company.street"> <span t-field="company.street"/><br/></t>
                        <t t-if="company.street2"> <span t-field="company.street2"/><br/></t>
                        <span t-if="company.city" t-field="company.city"></span>
                    </div>
                </div>
            </div>
            </div>
        </div>
        <div t-attf-class="article o_report_layout_boxed o_company_#{company.id}_layout {{  'o_layout_background' if company.layout_background in ['Geometric', 'Custom']  else  '' }}" t-attf-style="background-image: url({{ 'data:image/png;base64,%s' % company.layout_background_image.decode('utf-8') if company.layout_background_image and company.layout_background == 'Custom' else '/base/static/img/bg_background_template.jpg' }});" t-att-data-oe-model="o and o._name" t-att-data-oe-id="o and o.id" t-att-data-oe-lang="o and o.env.context.get('lang')">
            <div class="pt-5">
                <!-- This div ensures that the address is not cropped by the header. -->
                <t t-call="web.address_layout"/>
            </div>
            <t t-out="0"/>
        </div>
        <div t-attf-class="footer o_boxed_footer o_company_#{company.id}_layout">
            <div class="text-center">
                <!-- <div t-field="company.report_footer"/> -->
                <div><strong style="font-weight:600 !important;">simplee AG</strong> Im Schörli 5, 8600 Dübendorf <strong>E-Mail:</strong> <a href="mailto:hallo@simplee-energy.ch">hallo@simplee-energy.ch</a> <strong>Telefon:</strong> +41 58 510 89 00 <strong>Bank:</strong> Zürcher Kantonalbank<br/>
<strong>Kontoinhaber:</strong> simplee AG <strong>BIC:</strong> ZKBKCHZZ80A <strong>IBAN:</strong> CH71 0070 0110 0068 7576 0 <strong>MWST-Nr.:</strong> CHE-333.003.455 MWST<br/>
<strong>Umsatzsteuer-Identifikationsnummer:</strong> CHE-333.003.455 MWST <strong>Website:</strong> <a href="https://www.simplee-energy.ch/">www.simplee-energy.ch</a></div>
                <div t-if="report_type == 'pdf'">
                    Page: <span class="page"/> / <span class="topage"/>
                </div>
            </div>
        </div>
    </template>

    <!-- BASE override #For addresses-->
    <template id="web.address_layout">
        <t t-set="colclass" t-value="('col-sm-5' if report_type == 'html' else 'col-5') + ' ml-auto'"/>
        <t t-if="address">
            <div class="address row col-12">
                <t t-if="information_block">
                    <t t-set="colclass" t-value="'col-5 offset-1'"/>
                    <div name="information_block" class="row col-12">
                        <t t-out="information_block"/>
                    </div>
                </t>
                <div name="address" t-att-class="colclass">
                    <t t-esc="address"/>
                </div>
            </div>
        </t>
    </template>

    <!-- #Change address format-->
    <template id="pt_extend_addresses" inherit_id="sale.report_saleorder_document">
        <xpath expr="//t[@t-set='address']" position="replace">
            <t t-set="address">
            </t>
        </xpath>
        <xpath expr="//div[hasclass('page')]/h2[hasclass('mt16')]" position="attributes">
            <attribute name="class">mt16 pb-5</attribute>
        </xpath>
        <xpath expr="//t[@t-if='doc.partner_shipping_id == doc.partner_invoice_id
                             and doc.partner_invoice_id != doc.partner_id
                             or doc.partner_shipping_id != doc.partner_invoice_id']" position="replace">
            <t t-if="doc.partner_shipping_id == doc.partner_invoice_id
                                 and doc.partner_invoice_id != doc.partner_id
                                 or doc.partner_shipping_id != doc.partner_invoice_id">
                <t t-set="information_block">
                    <div class="col-6 pb-5">
                        <strong t-if="doc.partner_shipping_id == doc.partner_invoice_id">Invoicing and Shipping Address:</strong>
                        <strong t-if="doc.partner_shipping_id != doc.partner_invoice_id">Invoicing Address:</strong>
                        <div t-field="doc.partner_invoice_id"
                        t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": True}'/>
                    </div> 
                    <div class="col-6 pb-5">
                        <t t-if="doc.partner_shipping_id != doc.partner_invoice_id">
                            <strong>Shipping Address:</strong>
                            <div t-field="doc.partner_shipping_id"
                                t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": True}'/>
                        </t>
                    </div>
                </t>
            </t>
            <!-- <t t-else="">
                <t t-set="information_block">
                    <div class="col-6 pb-5">
                        <strong t-if="doc.company_id">Company Address:</strong>
                        <div name="company_address">
                            <t t-if="doc.company_id.street"> <span t-esc="doc.company_id.street"/><br/></t>
                            <t t-if="doc.company_id.street2"> <span t-esc="doc.company_id.street2"/><br/></t>
                            <span t-if="doc.company_id.city" t-esc="doc.company_id.city"></span>
                        </div>
                    </div>
                </t>
            </t> -->
        </xpath>
    </template>

<template id="pt_report_saleorder_document_new" inherit_id="sale.report_saleorder_document">
    <xpath expr="//th[@name='th_description']" position="before">
        <th name="th_pos" class="text-left">Pos.</th>
    </xpath>
    <xpath expr="//tbody[hasclass('sale_tbody')]" position="replace">
        <tbody class="sale_tbody">
            <t t-set="current_subtotal" t-value="0"/>
            <t t-set="is_section" t-value="False"/>
            <t t-foreach="doc.order_line" t-as="line">
                <t t-if="line.display_type == 'line_section'">
                  <t t-set="is_section" t-value="True"/> 
                </t>     
            </t>
            <t t-set="section_count" t-value="1"/>
            <t t-set="line_count" t-value="round(section_count + 0.1,2)"/>
            <t t-set="normal_line_count" t-value="1"/>
            <t t-foreach="doc.order_line" t-as="line">
                <t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal" groups="account.group_show_line_subtotals_tax_excluded"/>
                <t t-set="current_subtotal" t-value="current_subtotal + line.price_total" groups="account.group_show_line_subtotals_tax_included"/>
                <tr t-att-class="'bg-200 font-weight-bold o_line_section' if line.display_type == 'line_section' else 'font-italic o_line_note' if line.display_type == 'line_note' else ''">
                    <t t-if="not line.display_type">
                        <td name="td_pos">
                            <t t-if="is_section == True">
                               <t t-esc="line_count"/>
                            </t>
                            <t t-else="">
                               <t t-esc="normal_line_count"/>
                            </t>
                        </td>
                        <!--td name="td_name"><span t-field="line.name"/></td-->
                        <td name="td_name"><span t-esc="line.product_id.display_name"/><span t-esc="line.product_id.description"/></td>
                        <td name="td_quantity" class="text-right">
                            <span t-field="line.product_uom_qty"/>
                            <span t-field="line.product_uom"/>
                        </td>
                        <td name="td_priceunit" class="text-right">
                            <span t-field="line.price_unit"/>
                        </td>
                        <td t-if="display_discount" class="text-right" groups="product.group_discount_per_so_line">
                            <span t-field="line.discount"/>
                        </td>
                        <td name="td_taxes" class="text-right">
                            <span t-esc="', '.join(map(lambda x: (x.description or x.name), line.tax_id))"/>
                        </td>
                        <td name="td_subtotal" class="text-right o_price_total">
                            <span t-field="line.price_subtotal" groups="account.group_show_line_subtotals_tax_excluded"/>
                            <span t-field="line.price_total" groups="account.group_show_line_subtotals_tax_included"/>
                        </td>
                         <t t-if="is_section == True">
                            <t t-set="line_count" t-value="round(line_count + 0.1,2)"/>
                         </t>
                    </t>
                    <t t-if="line.display_type == 'line_section'">
                        <td name="pos_section">
                            <t t-esc="section_count"/>
                            <t t-if="is_section == True">
                               <t t-set="line_count" t-value="round(section_count + 0.1,2)"/>
                            </t>

                            <t t-set="section_count" t-value="section_count + 1"/>
                         </td>
                        <td name="td_section_line" colspan="99">
                            <span t-field="line.name"/>
                        </td>
                        <t t-set="current_section" t-value="line"/>
                        <t t-set="current_subtotal" t-value="0"/>
                    </t>
                    <t t-if="line.display_type == 'line_note'">
                        <td name="td_note_line" colspan="99">
                            <span t-field="line.name"/>
                        </td>
                    </t>
                </tr>
                <t t-set="normal_line_count" t-value="normal_line_count + 1"/>
                <t t-if="current_section and (line_last or doc.order_line[line_index+1].display_type == 'line_section')">
                    <tr class="is-subtotal text-right">
                        <td name="td_section_subtotal" colspan="99">
                            <strong class="mr16">Subtotal</strong>
                            <span t-esc="current_subtotal" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: doc.pricelist_id.currency_id}"/>
                        </td>
                    </tr>
                </t>
            </t>
        </tbody>
   </xpath>

   <xpath expr="//thead//tr//th[@name='th_taxes']" position="replace">
   </xpath>
   <xpath expr="//td[@name='td_taxes']" position="replace">
   </xpath>

</template>

<template id="pt_extend_optional_product_sale_report" inherit_id="sale_management.report_saleorder_document_inherit_sale_management">
    <xpath expr="//table[@name='table_optional_products']" position="replace">
        <table name="table_optional_products" class="table table-sm">
                <thead>
                    <tr>
                        <th name="th_pos" class="text-left">Pos.</th>
                        <th name="th_option_name" class="text-left">Description</th>
                        <th name="th_option_quantity" class="text-left">Quantity</th>
                        <th name="th_option_price_unit" class="text-right">Unit Price</th>
                        <th t-if="has_option_discount" name="th_option_discount" groups="product.group_discount_per_so_line" class="text-left">Disc.%</th>
                        <th name="th_option_amount" class="text-right">Amount</th>
                    </tr>
                </thead>
                <tbody class="sale_tbody">
                    <t t-set="option_current_subtotal" t-value="0"/>
                    <t t-set="optional_line_count" t-value="1"/>

                    <tr t-foreach="doc.sale_order_option_ids" t-as="option">
                        <td name="td_pos">
                            <t t-esc="optional_line_count"/>
                        </td>
                        <td name="td_option_name">
                            <!--span t-field="option.name"/-->
                            <span t-esc="option.product_id.display_name"/><span t-esc="option.product_id.description"/>
                        </td>
                        <td name="td_option_quantity">
                            <span t-field="option.quantity"/>
                            <span t-field="option.line_id.product_uom"/>
                        </td>
                        <td name="td_option_price_unit">
                            <strong class="text-right">
                                <div t-field="option.price_unit" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: doc.pricelist_id.currency_id}"/>
                            </strong>
                        </td>
                        <td t-if="has_option_discount" name="td_option_discount" groups="product.group_discount_per_so_line">
                            <strong t-if="option.discount != 0.0" class="text-info">
                                <t t-esc="((option.discount % 1) and '%s' or '%d') % option.discount"/>
                            </strong>
                        </td>
                        <td name='has_option_amount' class="text-right o_price_total">
                            <t t-set="option_price_total" t-value="(option.price_unit * option.quantity) - ((option.price_unit * option.quantity) * (option.discount or 0.0 / 100.0))"/>
                            <!-- (option.price_unit * option.quantity) - ((option.price_unit * option.quantity) * (option.discount or 0.0 / 100.0)) -->
                            <t t-esc="option_price_total"/>
                            <!-- <span t-field="option.line_id.price_subtotal" groups="account.group_show_line_subtotals_tax_excluded"/>
                            <span t-field="option.line_id.price_total" groups="account.group_show_line_subtotals_tax_included"/> -->
                        </td>
                        <!-- <td name='option_subtotal'> -->

                        <t t-set="option_current_subtotal" t-value="option_current_subtotal + option_price_total"/>
                        <!-- </td> -->
                        <t t-set="optional_line_count" t-value="optional_line_count + 1"/>
                    </tr>
                    <tr class="is-subtotal text-right">
                        <td name="td_section_subtotal" colspan="99">
                            <strong class="mr16">Subtotal</strong>
                            <span t-esc="option_current_subtotal" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: doc.pricelist_id.currency_id}"/>
                        </td>
                    </tr>
                </tbody>
            </table>
    </xpath>
</template>

</odoo>